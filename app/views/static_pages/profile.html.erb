<% levels = ["è‹±æ¤œ5ç´š", "è‹±æ¤œ4ç´š", "è‹±æ¤œ3ç´š", "è‹±æ¤œæº–2ç´š", "è‹±æ¤œæº–2ç´šãƒ—ãƒ©ã‚¹", "è‹±æ¤œ2ç´š", "è‹±æ¤œæº–1ç´š", "è‹±æ¤œ1ç´š"] %>
<% current_index = levels.index(current_user.eiken_level) || 0 %>
<% progress = ((current_index.to_f / (levels.length - 1)) * 100).round %>

<div class="eiken-container">

  <div class="eiken-card">

    <p class="eiken-title">ğŸ“ ã‚ãªãŸã®è‹±æ¤œç´š</p>

    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ -->
    <div class="progress-wrap">

      <div class="progress-ticks">
        <% levels.length.times do %><span></span><% end %>
      </div>

      <div class="progress-bar">
        <div class="progress-fill <%= 'complete' if current_index == levels.length - 1 %>"
             data-progress="<%= progress %>"></div>
      </div>

      <% if current_index == levels.length - 1 %>
        <div class="goal-flag">ğŸ</div>
      <% end %>
    </div>

    <!-- ç¾åœ¨ç´š -->
    <p class="current-level">
      ã‚ãªãŸã®è‹±æ¤œç´šï¼š<strong><%= current_user.eiken_level %></strong>
    </p>

    <!-- ç´šä¸€è¦§ -->
    <div class="level-scroll">
      <% levels.each_with_index do |level, index| %>
        <span class="level-pill
          <%= 'cleared' if index < current_index %>
          <%= 'active' if index == current_index %>">
          <%= level %>
        </span>
      <% end %>
    </div>

    <!-- ç·¨é›† -->
    <div class="eiken-edit">
      <%= link_to "è‹±æ¤œç´šã‚’å¤‰æ›´ã™ã‚‹",
        edit_profile_user_path(anchor: "eiken"),
        class: "edit-btn" %>
    </div>

  </div>
</div>

<!-- ğŸ‰ -->
<div id="confetti" class="confetti hidden">ğŸ‰ğŸ‰ğŸ‰</div>

<div id="level-data"
     data-current="<%= current_user.eiken_level %>"
     data-previous="<%= session[:previous_eiken_level] %>">
</div>

<%= render "shared/navigation_tab" %>

<style>
/* ===== ç”»é¢å…¨ä½“ ===== */
body {
  padding-bottom: 90px; /* navigation_tabå¯¾ç­– */
}

.eiken-container {
  display: flex;
  justify-content: center;
  padding: 24px 16px;
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.eiken-card {
  width: 100%;
  max-width: 720px;
  padding: 20px;
  background: #f9fafb;
  border-radius: 18px;
  border: 1px dashed #d1d5db;
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ« ===== */
.eiken-title {
  font-weight: 700;
  margin-bottom: 18px;
}

/* ===== ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ ===== */
.progress-wrap {
  position: relative;
  margin: 20px 0 24px;
  padding-top: 14px;
}

.progress-bar {
  height: 14px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0%;
  min-width: 6px;
  background: linear-gradient(90deg, #fb923c, #f97316);
  border-radius: 999px;
  transition: width 0.8s ease;
}

.progress-fill.complete {
  background: linear-gradient(90deg, #facc15, #eab308);
}

/* ç›®ç››ã‚Š */
.progress-ticks {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
}

.progress-ticks span {
  width: 2px;
  height: 20px;
  background: #d1d5db;
}

/* ãƒ•ãƒ©ãƒƒã‚° */
.goal-flag {
  position: absolute;
  right: -4px;
  top: -28px;
  font-size: 1.2rem;
}

/* ===== ç¾åœ¨ç´š ===== */
.current-level {
  text-align: center;
  font-size: 0.9rem;
  margin-bottom: 12px;
}

.current-level strong {
  color: #f97316;
}

/* ===== ç´šä¸€è¦§ ===== */
.level-scroll {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 6px 0 10px;
}

.level-pill {
  flex: none;
  min-width: 84px;
  padding: 6px 12px;
  border-radius: 999px;
  background: #e5e7eb;
  font-size: 0.7rem;
  color: #6b7280;
  text-align: center;
  white-space: nowrap;
}

.level-pill.cleared {
  background: #ffedd5;
  color: #9a3412;
}

.level-pill.active {
  background: #f97316;
  color: #fff;
  font-weight: 700;
}

/* ===== ç·¨é›†ãƒœã‚¿ãƒ³ ===== */
.eiken-edit {
  margin-top: 20px;
  text-align: center;
}

.edit-btn {
  display: block;
  width: 100%;
  max-width: 320px;
  margin: 0 auto;
  padding: 14px;
  border-radius: 999px;
  background: #fff7ed;
  color: #f97316;
  font-weight: 700;
  border: 2px solid #fdba74;
  text-decoration: none;
}

.edit-btn:hover {
  background: #f97316;
  color: #fff;
}

/* ===== ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ ===== */
.confetti {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  z-index: 9999;
  animation: fadeOut 2.5s forwards;
}

.confetti.hidden {
  display: none;
}

@keyframes fadeOut {
  0%, 70% { opacity: 1; }
  100% { opacity: 0; visibility: hidden; }
}
</style>

<script>
document.addEventListener("turbo:load", () => {
  const bar = document.querySelector(".progress-fill");
  if (!bar) return;

  const progress = bar.dataset.progress || 0;
  bar.style.width = "0%";

  requestAnimationFrame(() => {
    bar.style.width = progress + "%";
  });
});

document.addEventListener("turbo:load", () => {
  const data = document.getElementById("level-data");
  if (!data) return;

  const levels = ["è‹±æ¤œ5ç´š","è‹±æ¤œ4ç´š","è‹±æ¤œ3ç´š","è‹±æ¤œæº–2ç´š","è‹±æ¤œæº–2ç´šãƒ—ãƒ©ã‚¹","è‹±æ¤œ2ç´š","è‹±æ¤œæº–1ç´š","è‹±æ¤œ1ç´š"];
  const current = data.dataset.current;
  const previous = data.dataset.previous;

  if (!current || !previous) return;

  if (levels.indexOf(current) > levels.indexOf(previous)) {
    const confetti = document.getElementById("confetti");
    confetti.classList.remove("hidden");
    setTimeout(() => confetti.remove(), 2500);
  }
});
</script>
