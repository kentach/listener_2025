<div class="vocab-page">
  <!-- å·¦ä¸Šæˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <%= link_to "ï¼œè‹±æ¤œç´šã«æˆ»ã‚‹", vocabularies_path, class: "btn-back" %>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="vocab-header">
    <h2>è‹±æ¤œ<%= @level %> é‡è¦å˜èªãƒªã‚¹ãƒˆ</h2>
    <h4>å…¨<%= @vocabularies.count %>èª</h4>
  </header>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="search-wrapper">
    <%= form_with url: level_vocabularies_path, method: :get, class: "vocab-search-form", local: true do %>
      <%= hidden_field_tag :level, @level %>
      <input type="search" name="q" placeholder="è‹±èª / æ—¥æœ¬èªã§æ¤œç´¢" class="search-input" autocomplete="off">
      <button type="submit">ğŸ”</button>
    <% end %>
  </div>

  <!-- æ¤œç´¢çŠ¶æ…‹è¡¨ç¤º -->
  <div class="search-status" hidden>
    ã€Œ<span class="search-keyword"></span>ã€ã®æ¤œç´¢çµæœ
  </div>

  <!-- æ¤œç´¢çµæœ -->
  <div class="search-results" hidden></div>

  <!-- ä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <div class="search-actions" hidden>
    <button type="button" class="btn-return">â† ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹</button>
  </div>

  <!-- ã‚·ãƒªãƒ¼ã‚ºä¸€è¦§ -->
  <div class="series-list">
    <% @vocabularies.group_by(&:series).each do |series, words| %>
      <div class="series-block">
        <div class="series-header"
             onclick="this.nextElementSibling.classList.toggle('open');
                      this.querySelector('.toggle-icon').textContent =
                      this.nextElementSibling.classList.contains('open') ? 'âˆ’' : '+';">
          <span><%= series %>ï¼ˆ<%= words.count %>èªï¼‰</span>
          <span class="toggle-icon">+</span>
        </div>

        <div class="series-words">
          <div class="series-actions">
            <%= link_to "æš—è¨˜ã‚’å§‹ã‚ã‚‹",
                memorization_vocabularies_path(level: @level, series: series),
                class: "btn-action btn-memo" %>

            <%= button_to "ãƒ†ã‚¹ãƒˆã«æŒ‘æˆ¦",
                  tests_path,
                  method: :post,
                  params: {
                    series: series,
                    level: @level,
                    range_start: words.first.number,
                    range_end: words.last.number,
                    question_language: "english"
                  },
                  class: "btn-action btn-test" %>
          </div>

          <% words.each do |word| %>
            <div class="word-card">
              <div class="word-info">
                <span class="word-number"><%= word.number %>.</span>
                <span class="word-english"><%= word.english %></span>
                <span class="word-japanese"><%= word.japanese %></span>
              </div>
              <button class="play-btn" data-word="<%= word.english %>">
                <i class="bi bi-volume-up"></i>
              </button>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= render "shared/navigation_tab" %>

<style>
/* ===== ãƒšãƒ¼ã‚¸å…¨ä½“ ===== */
.vocab-page {
  max-width: 600px;
  margin: 0 auto;
  padding: 16px;
  padding-bottom: 120px;
  font-family: sans-serif;
}

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
.btn-back {
  display: inline-block;
  margin-bottom: 16px;
  padding: 8px 16px;
  background: #ccc;
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  font-weight: bold;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.vocab-header { text-align: center; margin-bottom: 20px; }

/* æ¤œç´¢ãƒãƒ¼ */
.search-wrapper {
  position: sticky;
  top: 0;
  z-index: 200;
  background: #fff;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
}

.vocab-search-form {
  display: flex;
}

.vocab-search-form input {
  flex: 1;
  padding: 10px 14px;
  border-radius: 12px 0 0 12px;
  border: 1px solid #ccc;
}

.vocab-search-form button {
  padding: 0 16px;
  border-radius: 0 12px 12px 0;
  border: 1px solid #1081e3;
  background: #1081e3;
  color: #fff;
}

/* æ¤œç´¢çµæœè¡¨ç¤º */
.search-status {
  margin-top: 8px;
  text-align: center;
  font-size: 14px;
  color: #555;
}

.search-results { margin-top: 8px; }
.no-result {
  text-align: center;
  color: #777;
  padding: 20px;
}

.search-actions {
  position: sticky;
  top: 64px;
  z-index: 180;
  background: #fff;
  padding: 8px 0 12px;
  border-bottom: 1px solid #eee;
}

.btn-return {
  width: 100%;
  padding: 12px 0;
  background: #f1f1f1;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: bold;
  color: #333;
}

.btn-return:active { background: #ddd; }

/* ã‚·ãƒªãƒ¼ã‚º */
.series-block {
  margin-bottom: 24px;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.12);
  overflow: hidden;
}

.series-header {
  background: #333;
  color: #fff;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
}

.series-words { display: none; padding: 12px; background: #f7f7f7; }
.series-words.open { display: block; }

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.series-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.btn-action {
  flex: 1;                      /* æ¨ªå¹…æƒãˆ */
  padding: 12px 0;
  border-radius: 8px;
  color: #fff;
  text-decoration: none;
  text-align: center;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-memo { background: #f87b0e; }
.btn-test {
  background: #2196F3;
  border: none;
  cursor: pointer;
}

/* å˜èªã‚«ãƒ¼ãƒ‰ */
.word-card {
  display: flex;
  justify-content: space-between;
  padding: 10px 16px;
  margin-bottom: 8px;
  background: #fff;
  border-radius: 8px;
}

.word-english { font-weight: 600; }

.play-btn {
  background: #65baffff;
  border: none;
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
}

.play-btn:active { transform: scale(0.95); }
.play-btn i { pointer-events: none; }

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media screen and (max-width: 480px) {
  .vocab-page { padding: 12px; }
  .vocab-search-form input { padding: 8px 10px; }
  .vocab-search-form button { padding: 0 10px; }
  .btn-action { padding: 10px 0; font-size: 14px; }
  .word-card { padding: 8px 10px; font-size: 14px; }
}
</style>

<script>
document.addEventListener("turbo:load", () => {
  /* ===== ç™ºéŸ³æº–å‚™ ===== */
  let voices = [];
  function loadVoices() { voices = speechSynthesis.getVoices(); }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function speak(word) {
    if (!word) return;
    const utter = new SpeechSynthesisUtterance(word);
    utter.lang = "en-US";
    utter.rate = 0.95;
    utter.voice = voices.find(v => v.lang.startsWith("en")) || voices[0];
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }

  /* ===== ç™ºéŸ³ãƒœã‚¿ãƒ³ï¼ˆå§”è­²ï¼‰ ===== */
  document.addEventListener("click", e => {
    const btn = e.target.closest(".play-btn");
    if (!btn) return;
    speak(btn.dataset.word);
  });

  /* ===== æ¤œç´¢æ©Ÿèƒ½ ===== */
  const form = document.querySelector(".vocab-search-form");
  const input = document.querySelector(".search-input");
  const results = document.querySelector(".search-results");
  const seriesList = document.querySelector(".series-list");
  const status = document.querySelector(".search-status");
  const keyword = document.querySelector(".search-keyword");
  const backBtn = document.querySelector(".search-actions .btn-return");

  form.addEventListener("submit", e => e.preventDefault());

  input.addEventListener("input", () => {
    const q = input.value.trim().toLowerCase();
    if (!q) {
      results.hidden = true;
      status.hidden = true;
      seriesList.style.display = "";
      backBtn.parentElement.hidden = true;
      return;
    }

    keyword.textContent = q;
    status.hidden = false;
    results.hidden = false;
    seriesList.style.display = "none";
    backBtn.parentElement.hidden = false;

    results.innerHTML = "";
    let hit = 0;

    document.querySelectorAll(".word-card").forEach(card => {
      const en = card.querySelector(".word-english").textContent.toLowerCase();
      const ja = card.querySelector(".word-japanese").textContent.toLowerCase();

      if (en.includes(q) || ja.includes(q)) {
        hit++;
        const clone = card.cloneNode(true);
        results.appendChild(clone);
      }
    });

    if (hit === 0) {
      results.innerHTML = `<div class="no-result">è©²å½“ã™ã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }
  });

  backBtn.addEventListener("click", () => {
    input.value = "";
    results.hidden = true;
    status.hidden = true;
    seriesList.style.display = "";
    backBtn.parentElement.hidden = true;
  });
});
</script>
