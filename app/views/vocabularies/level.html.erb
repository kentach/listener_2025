<div class="container" style="max-width: 600px; margin-top: 20px;">
  <%= link_to "ï¼œè‹±æ¤œç´š", vocabularies_path, class: "text-dark text-decoration-none" %>
</div>

<section class="vocab-series-list" style="max-width: 600px; margin-top: 20px;">
  <h2>è‹±æ¤œ<%= @level %>ã€€é‡è¦å˜èªãƒªã‚¹ãƒˆ</h2>

<div style="display:flex; justify-content:center; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
  <%= form_with url: level_vocabularies_path(level: @level), method: :get, local: true, class: "vocab-search-form", style: "display:flex; gap:8px;" do %>
    <%= hidden_field_tag :level, params[:level] %>
    <input type="text" name="q" placeholder="å˜èªã‚’æ¤œç´¢..." 
           value="<%= params[:q] %>"
           style="flex:1; max-width:300px; padding:8px 12px; font-size:14px; border-radius:8px; border:1px solid #ccc;">
    <button type="submit" style="padding:8px 16px; font-size:14px; border-radius:8px; border:none; background-color:#2196F3; color:white; cursor:pointer;">
        ğŸ” æ¤œç´¢
    </button>
  <% end %>

  <% if params[:q].present? %>
    <%= link_to "ï¼œå…ƒã®å˜èªãƒªã‚¹ãƒˆã«æˆ»ã‚‹", level_vocabularies_path(level: params[:level]), class: "btn-back", style: "padding:8px 16px; border-radius:8px; background-color:#ccc; color:#333; text-decoration:none; height:100%;" %>
  <% end %>
</div>




  <% series_colors = {
    "ç–‘å•è©" => "#4CAF50",
    "å‹•è©ã‚·ãƒªãƒ¼ã‚º1" => "#2196F3",
    "å‹•è©ã‚·ãƒªãƒ¼ã‚º2" => "#216ef3ff",
    "æ™‚é–“" => "#FF9800",
    "å ´æ‰€" => "#9C27B0",
    "å¤©æ°—" => "#033bf4ff",
    "ã‚¹ãƒãƒ¼ãƒ„" => "#E91E63",
    "å®¶" => "#795548",
    "æ›œæ—¥" => "#2ec33fff",
    "æ•°ãƒ»é †åº" => "rgba(39, 156, 219, 1)",
    "æœˆ" => "#607D8B",
    "ä¹—ã‚Šç‰©" => "#4CAF50"
  } %>

<% @vocabularies.group_by(&:series).each do |series, words| %>
  <div class="series-block" style="margin-bottom:16px;">
    <div class="series-header" 
         style="background-color: <%= series_colors[series] || '#333' %>;"
         onclick="this.nextElementSibling.classList.toggle('collapsed'); 
                  this.querySelector('.toggle-icon').textContent = this.nextElementSibling.classList.contains('collapsed') ? '+' : 'âˆ’';">
      <%= series %> ï¼ˆ<%= words.count %>èªï¼‰
      <span class="toggle-icon">+</span>
    </div>
    

    <div class="series-words collapsed">
     <div style="margin-top:8px; margin-bottom:8px; text-align:center;">
        <%= link_to "ã“ã®ã‚·ãƒªãƒ¼ã‚ºã‚’æš—è¨˜", memorization_vocabularies_path(level: @level, series: series), class: "btn-start-memo" %>
      </div>
      <% words.each do |word| %>
        <div class="word-card">
          <div class="word-info">
            <span class="word-number"><%= word.number %>.</span>
            <span class="word-english"><%= word.english %></span>
            <span class="word-japanese"><%= word.japanese %></span>
          </div>
          <div class="word-play">
            <button class="play-btn">ğŸ”Š ç™ºéŸ³</button>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

</section>

<%= render "shared/navigation_tab" %>

<style>
.word-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  margin-bottom: 6px;
  border-radius: 8px;
  background-color: #f7f7f7;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.word-info {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

.word-number {
  font-size: 14px;
  color: #666;
}

.word-english {
  font-size: 16px;
  font-weight: 600;
}

.word-japanese {
  font-size: 14px;
  color: #333;
}

.word-play {
  display: flex;
  gap: 6px;
  align-items: center;
}

.word-play .play-btn {
  padding: 6px 12px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
  background-color: #2196F3;
  color: #fff;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.2s;
}

.word-play .play-btn:hover {
  background-color: #1976D2;
  transform: translateY(-2px);
}

.series-block {
  margin-bottom: 16px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.series-header {
  color: #fff;
  padding: 12px 16px;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.series-words {
  display: none;
  background-color: #f9f9f9;
  padding: 8px 0;
}

.series-words:not(.collapsed) {
  display: block;
}

.vocab-series-list {
  width: 95%;
  margin: 0 auto;
  font-family: sans-serif;
  padding-bottom: 80px; /* ã‚¿ãƒ–ã®é«˜ã• + ä½™è£•åˆ† */
}

.btn-start-memo {
  display: inline-block;
  padding: 10px 20px;
  background-color: #f87b0eff;
  color: #fff;
  font-weight: bold;
  border-radius: 8px;
  text-decoration: none;
  transition: background-color 0.2s;
}
.btn-start-memo:hover { background-color: #c66613ff; }

@media (max-width: 600px) {
  .series-header { font-size: 14px; padding: 10px 12px; }
  .word-card { padding: 8px 12px; }
  .word-english { font-size: 15px; }
  .word-japanese { font-size: 13px; }
  .word-play .play-btn { font-size: 13px; padding: 5px 10px; }
}
</style>

<script>
document.addEventListener("turbo:load", () => {
  // ãƒœã‚¤ã‚¹ãƒ­ãƒ¼ãƒ‰
  let voices = [];
  function loadVoices(callback) {
    voices = speechSynthesis.getVoices();
    if (voices.length > 0) {
      callback();
    } else {
      speechSynthesis.onvoiceschanged = () => {
        voices = speechSynthesis.getVoices();
        callback();
      };
    }
  }

  function speakWord(text) {
    if (!('speechSynthesis' in window) || !text) return;

    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    utterance.pitch = 1.0;

    const enVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
    if (enVoice) utterance.voice = enVoice;

    speechSynthesis.speak(utterance);
  }

  loadVoices(() => {
    document.querySelectorAll(".play-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const word = btn.closest(".word-card").querySelector(".word-english").textContent;
        speakWord(word);
      });
    });
  });
});

</script>
