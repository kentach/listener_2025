<div class="clear-container">
  <h1>ğŸ‰ ãŠã‚ã§ã¨ã†ï¼ ğŸ‰</h1>
  <p class="clear-text">å˜èªã®æš—è¨˜ã‚’å®Œäº†ã—ã¾ã—ãŸï¼</p>

  <p class="congrats-message">ç´ æ™´ã‚‰ã—ã„ï¼ã‚ãªãŸã®åŠªåŠ›ãŒç¢ºå®Ÿã«åŠ›ã«ãªã£ã¦ã„ã¾ã™</p>
  <p class="congrats-message">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚‚ã€ã“ã®å‹¢ã„ã§æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>

  <div class="progress-wrapper">
    <div class="progress-bar" id="progress-bar">0%</div>
  </div>
</div>

<!-- å­¦ç¿’çµæœ -->
<div id="learned-section" class="learned-section" style="display:none;">
  <h2 class="learned-title known">âœ… çŸ¥ã£ã¦ã„ã‚‹å˜èª</h2>
  <div class="word-list" id="known-cards"></div>

  <h2 class="learned-title unknown">â— çŸ¥ã‚‰ãªã„å˜èª</h2>
  <div class="word-list" id="unknown-cards"></div>
</div>

<!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<div class="back-btn-wrapper">
  <%= link_to "å˜èªãƒªã‚¹ãƒˆã«æˆ»ã‚‹",
    level_vocabularies_path(level: params[:level]),
    class: "back-btn" %>
</div>

<%= render "shared/navigation_tab" %>

<style>
/* ===== ã‚¯ãƒªã‚¢ç”»é¢ ===== */
.clear-container {
  text-align: center;
  padding: 48px 16px 24px;
}

.clear-container h1 {
  font-size: 36px;
  color: #4CAF50;
}

.clear-text {
  font-size: 18px;
  margin-bottom: 10px;
}

.congrats-message {
  font-size: 16px;
  color: #000;
  font-weight: 600;
}

/* ===== é€²æ—ãƒãƒ¼ ===== */
.progress-wrapper {
  margin: 24px auto 0;
  width: 80%;
  max-width: 360px;
  height: 26px;
  background: #eee;
  border-radius: 20px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: #fbc02d;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width 0.2s;
}

/* ===== å­¦ç¿’çµæœ ===== */
.learned-section {
  padding: 24px 16px 120px;
  max-width: 720px;
  margin: 0 auto;
}

.learned-title {
  font-size: 20px;
  font-weight: 700;
  margin: 28px 0 12px;
}

.learned-title.known { color: #2e7d32; }
.learned-title.unknown { color: #c62828; }

/* ===== ç¸¦ãƒªã‚¹ãƒˆ ===== */
.word-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.word-row {
  background: #fff;
  border-radius: 14px;
  padding: 14px 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.word-info .en {
  font-size: 18px;
  font-weight: 700;
}

.word-info .jp {
  font-size: 14px;
  color: #666;
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
.word-actions {
  display: flex;
  gap: 10px;
}

.word-actions button {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #fff;
}

.btn-audio { background: #2f6df6; }
.btn-save { background: #ff9800; }

/* ===== æˆ»ã‚‹ãƒœã‚¿ãƒ³ ===== */
.back-btn-wrapper {
  position: fixed;
  bottom: 64px;
  left: 0;
  width: 100%;
  padding: 12px 16px;
  background: linear-gradient(to top, rgba(255,255,255,0.95), rgba(255,255,255,0));
  z-index: 20;
}

.back-btn {
  display: block;
  max-width: 420px;
  margin: 0 auto;
  padding: 14px 0;
  background: #ef9311ff;
  color: #fff;
  font-weight: 700;
  border-radius: 999px;
  text-align: center;
  text-decoration: none;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}
</style>
<script>
document.addEventListener("turbo:load", () => {

  /* ===== é€²æ—ãƒãƒ¼ ===== */
  const bar = document.getElementById("progress-bar");
  let p = 0;
  const timer = setInterval(() => {
    p++;
    bar.style.width = p + "%";
    bar.textContent = p + "%";
    if (p >= 100) clearInterval(timer);
  }, 15);

  /* ===== éŸ³å£° ===== */
  let voices = [];
  function loadVoices() { voices = speechSynthesis.getVoices(); }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function speak(text) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    u.voice = voices.find(v => v.lang.startsWith("en")) || voices[0];
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  /* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
  const knownWords   = JSON.parse(localStorage.getItem("knownWords") || "[]");
  const unknownWords = JSON.parse(localStorage.getItem("unknownWords") || "[]");

  if (knownWords.length === 0 && unknownWords.length === 0) return;
  document.getElementById("learned-section").style.display = "block";

  const knownBox   = document.getElementById("known-cards");
  const unknownBox = document.getElementById("unknown-cards");

  function render(word, box, saveable) {
    const row = document.createElement("div");
    row.className = "word-row";
    row.innerHTML = `
      <div class="word-info">
        <div class="en">${word.english}</div>
        <div class="jp">${word.japanese}</div>
      </div>
      <div class="word-actions">
        <button class="btn-audio"><i class="bi bi-volume-up"></i></button>
        ${saveable ? `<button class="btn-save"><i class="bi bi-bookmark-star"></i></button>` : ""}
      </div>
    `;

    row.querySelector(".btn-audio").onclick = () => speak(word.english);

    if (saveable) {
      row.querySelector(".btn-save").onclick = () => {
        const weak = JSON.parse(localStorage.getItem("weakWords") || "[]");
        if (!weak.some(w => w.english === word.english)) {
          weak.push(word);
          localStorage.setItem("weakWords", JSON.stringify(weak));
          alert("è‹¦æ‰‹å˜èªã«ä¿å­˜ã—ã¾ã—ãŸ");
        }
      };
    }

    box.appendChild(row);
  }

  if (knownWords.length === 0)
    document.querySelector(".learned-title.known").style.display = "none";
  else knownWords.forEach(w => render(w, knownBox));

  if (unknownWords.length === 0)
    document.querySelector(".learned-title.unknown").style.display = "none";
  else unknownWords.forEach(w => render(w, unknownBox, true));

  localStorage.removeItem("knownWords");
  localStorage.removeItem("unknownWords");
});
</script>
