<div class="container" style="max-width: 600px; margin-top: 30px;">
  <%= link_to "ï¼œå˜èªãƒªã‚¹ãƒˆ", level_vocabularies_path(level: params[:level]), class: "text-dark text-decoration-none" %>
</div>

<div class="time-wrapper">
  <div class="time-bar" id="time-bar"></div>
</div>

<div class="single-card-wrapper">
  <div class="flash-card" id="flash-card">
    <div class="card-inner">

      <!-- è¡¨ -->
      <div class="card-face card-front">
        <div class="word-english" id="word-english"></div>
        <button id="play-word" class="play-word-btn">ğŸ”Š</button>
      </div>

      <!-- è£ -->
      <div class="card-face card-back">
        <div class="word-english" id="word-english-back"></div>
        <div class="word-japanese" id="word-japanese"></div>
        <button id="play-word-back" class="play-word-btn">ğŸ”Š</button>
      </div>

    </div>
  </div>

  <!-- é€²æ—ãƒãƒ¼ -->
  <div class="progress-wrapper">
    <div class="progress-bar" id="progress-bar">0%</div>
  </div>
</div>

<div class="card-controls">
  <button id="btn-dontknow" class="circle-btn dontknow">
    <i class="bi bi-hand-thumbs-down-fill"></i>
    <span>çŸ¥ã‚‰ãªã„</span>
  </button>

  <button id="btn-know" class="circle-btn know">
    <i class="bi bi-hand-thumbs-up-fill"></i>
    <span>ã‚ã‹ã‚‹</span>
  </button>
</div>

<script>
  window.VOCABULARIES = <%= raw @vocabularies.to_json(only: [:english, :japanese]) %>;
</script>

<style>
/* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã¯ transition ã‚’åˆ‡ã‚‹ */
.flash-card.dragging {
  transition: none;
}

/* ã‚¹ãƒ¯ã‚¤ãƒ—æ–¹å‘ã®èƒŒæ™¯è‰² */
.flash-card.bg-know {
  background: #E8F5E9;
}

.flash-card.bg-dontknow {
  background: #FDECEA;
}

/* ä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚‚åŒæ™‚ã«è‰²ã‚’å¤‰ãˆã‚‹ */
.flash-card.bg-know .card-face {
  background: #E8F5E9;
}

.flash-card.bg-dontknow .card-face {
  background: #FDECEA;
}

.time-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 6px;
  background: #eee;
  z-index: 200;
}

.time-bar {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #4CAF50, #FF9800, #E53935);
  transition: width 1s linear;
}


.single-card-wrapper {
  min-height: 60vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.flash-card {
  width: 90%;
  max-width: 360px;
  height: 240px;
  perspective: 1000px;
}

.card-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.55s cubic-bezier(.4,.2,.2,1);
}

.flash-card.is-flipped .card-inner {
  transform: rotateY(180deg);
}

.card-face {
  position: absolute;
  inset: 0;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.card-back { transform: rotateY(180deg); }

.word-english { font-size: 25px; font-weight: 700; }
.word-japanese { margin-top: 12px; color: #666; }

.play-word-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  background: #2f6df6;
  color: #fff;
}

.progress-wrapper {
  width: 90%;
  max-width: 360px;
  height: 20px;
  background: #eee;
  border-radius: 20px;
  margin-top: 20px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: #FF9800;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  transition: width 0.3s;
}

.card-controls {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 32px;
  z-index: 100;
}

.circle-btn {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  border: none;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

.know { background: linear-gradient(135deg,#4CAF50,#43A047); }
.dontknow { background: linear-gradient(135deg,#E53935,#D32F2F); }

/* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ */
.flash-card.dragging .card-inner {
  transition: none;
}

/* å³ã«é£›ã¶ï¼ˆã‚ã‹ã‚‹ï¼‰ */
.flash-card.fly-right {
  transform: translateX(120%) rotate(12deg);
  opacity: 0;
  transition: transform 0.35s ease, opacity 0.35s ease;
}

/* å·¦ã«é£›ã¶ï¼ˆçŸ¥ã‚‰ãªã„ï¼‰ */
.flash-card.fly-left {
  transform: translateX(-120%) rotate(-12deg);
  opacity: 0;
  transition: transform 0.35s ease, opacity 0.35s ease;
}

.flash-card.bg-know .card-face {
  background: #E8F5E9;
}

.flash-card.bg-dontknow .card-face {
  background: #FDECEA;
}

</style>

<script>
document.addEventListener("turbo:load", () => {
  const vocabularies = window.VOCABULARIES;
  if (!vocabularies || vocabularies.length === 0) return;

  const card = document.getElementById("flash-card");
  const englishEl = document.getElementById("word-english");
  const englishBackEl = document.getElementById("word-english-back");
  const japaneseEl = document.getElementById("word-japanese");
  const playBtn = document.getElementById("play-word");
  const playBtnBack = document.getElementById("play-word-back");
  const progressBar = document.getElementById("progress-bar");
  const timeBar = document.getElementById("time-bar");

  const knownBtn = document.getElementById("btn-know");
  const unknownBtn = document.getElementById("btn-dontknow");

  let current = 0;
  let unknownWords = [];

  /* ===== éŸ³å£° ===== */
  let voices = [];
  function loadVoices() { voices = speechSynthesis.getVoices(); }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function speak(word) {
    const u = new SpeechSynthesisUtterance(word);
    u.lang = "en-US";
    u.rate = 0.95;
    u.voice = voices.find(v => v.lang.startsWith("en")) || voices[0];
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  /* ===== ã‚¿ã‚¤ãƒãƒ¼ ===== */
  const TIME_LIMIT = 8;
  let timerInterval;

  function startTimer() {
    clearInterval(timerInterval);
    let timeLeft = TIME_LIMIT;
    timeBar.style.width = "100%";

    timerInterval = setInterval(() => {
      timeLeft--;
      timeBar.style.width = (timeLeft / TIME_LIMIT) * 100 + "%";

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        swipeResult("left");
      }
    }, 1000);
  }

  /* ===== è¡¨ç¤º ===== */
  function updateProgress() {
    const percent = Math.round(((current + 1) / vocabularies.length) * 100);
    progressBar.style.width = percent + "%";
    progressBar.textContent = percent + "%";
  }

  function renderCard() {
    if (current >= vocabularies.length) {
      localStorage.setItem("unknownWords", JSON.stringify(unknownWords));
      window.location.href = "<%= clear_vocabularies_path(level: params[:level]) %>";
      return;
    }

    const word = vocabularies[current];
    englishEl.textContent = word.english;
    englishBackEl.textContent = word.english;
    japaneseEl.textContent = word.japanese;

    card.className = "flash-card";
    card.style.transform = "";

    speak(word.english);
    updateProgress();
    startTimer();
  }

  renderCard();

  /* ===== ã‚¯ãƒªãƒƒã‚¯ ===== */
  card.addEventListener("click", () => {
    card.classList.toggle("is-flipped");
  });

  playBtn.onclick = e => { e.stopPropagation(); speak(englishEl.textContent); };
  playBtnBack.onclick = e => { e.stopPropagation(); speak(englishBackEl.textContent); };

  knownBtn.onclick = () => swipeResult("right");
  unknownBtn.onclick = () => swipeResult("left");

  /* ===== ã‚¹ãƒ¯ã‚¤ãƒ— ===== */
  let startX = 0;
  let currentX = 0;
  let dragging = false;

  card.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    dragging = true;
    card.classList.add("dragging");
  });

  card.addEventListener("touchmove", e => {
    if (!dragging) return;

    currentX = e.touches[0].clientX - startX;

    card.style.transform =
      `translateX(${currentX}px) rotate(${currentX / 15}deg)`;

    card.classList.remove("bg-know", "bg-dontknow");
    if (currentX > 40) card.classList.add("bg-know");
    if (currentX < -40) card.classList.add("bg-dontknow");
  });

  card.addEventListener("touchend", () => {
    dragging = false;
    card.classList.remove("dragging", "bg-know", "bg-dontknow");

    if (Math.abs(currentX) > 80) {
      swipeResult(currentX > 0 ? "right" : "left");
    } else {
      card.style.transform = "";
    }
    currentX = 0;
  });

  function swipeResult(direction) {
    clearInterval(timerInterval);

    if (direction === "right") {
      card.classList.add("fly-right");
    } else {
      card.classList.add("fly-left");
      unknownWords.push(vocabularies[current]);
    }

    setTimeout(() => {
      current++;
      renderCard();
    }, 300);
  }
});
</script>
