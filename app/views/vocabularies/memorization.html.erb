<div class="container" style="max-width: 600px; margin-top: 30px;">
  <%= link_to "ÔºúÂçòË™û„É™„Çπ„Éà", level_vocabularies_path(level: params[:level]), class: "text-dark text-decoration-none" %>
</div>

<div class="single-card-wrapper">
  <div class="flash-card" id="flash-card">
    <div class="card-inner">

      <!-- Ë°® -->
      <div class="card-face card-front">
        <div class="word-english" id="word-english"></div>
        <button id="play-word" class="play-word-btn">üîä</button>
      </div>

      <!-- Ë£è -->
      <div class="card-face card-back">
        <div class="word-english" id="word-english-back"></div>
        <div class="word-japanese" id="word-japanese"></div>
        <button id="play-word-back" class="play-word-btn">üîä</button>
      </div>

    </div>
  </div>

  <!-- ÈÄ≤Êçó„Éê„Éº -->
  <div class="progress-wrapper">
    <div class="progress-bar" id="progress-bar">0%</div>
  </div>
</div>

<div class="card-controls">
  <button id="prev-card" class="btn-prev">Ââç„Å∏</button>
  <button id="next-card" class="btn-next">Ê¨°„Å∏</button>
</div>

<script>
  window.VOCABULARIES = <%= raw @vocabularies.to_json(only: [:english, :japanese]) %>;
</script>

<style>
/* „Ç´„Éº„ÉâÂÖ®‰Ωì */
.single-card-wrapper {
  width: 100%;
  min-height: 60vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px;
}

/* „Ç´„Éº„ÉâÊú¨‰Ωì */
.flash-card {
  width: 90%;
  max-width: 360px;
  height: 240px;
  perspective: 1000px;
}

.card-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transition: transform 0.5s ease;
  transform-style: preserve-3d;
}

.flash-card.is-flipped .card-inner {
  transform: rotateY(180deg);
}

.card-face {
  position: absolute;
  inset: 0;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.card-back {
  transform: rotateY(180deg);
}

/* Ëã±Ë™û„ÉªÊó•Êú¨Ë™û */
.word-english { font-size: 25px; font-weight: 700; letter-spacing: 0.5px; }
#word-english-back { font-size: 20px; font-weight: 700; }
#word-japanese { font-size: 16px; color: #666; margin-top: 14px; }

/* Áô∫Èü≥„Éú„Çø„É≥ */
.play-word-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 32px;
  height: 32px;
  font-size: 16px;
  border: none;
  border-radius: 50%;
  background-color: #2f6df6;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* „Ç´„Éº„ÉâÊìç‰Ωú„Éú„Çø„É≥ */
.card-controls {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 16px;
}

.card-controls button {
  width: 110px;
  padding: 6px 0;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  color: #fff;
  cursor: pointer;
}

.btn-prev { background-color: #2f6df6; }
.btn-next { background-color: #e64545; }
.card-controls button:active { transform: scale(0.97); }

/* ÈÄ≤Êçó„Éê„Éº */
.progress-wrapper {
  width: 90%;
  max-width: 360px;
  height: 20px;
  background-color: #eee;
  border-radius: 20px;
  overflow: hidden;
  margin-top: 20px;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background-color: #FF9800; /* „Ç™„É¨„É≥„Ç∏ */
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width 0.3s ease;
}

/* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
@media (max-width: 480px) {
  .flash-card { max-width: 280px; height: 200px; }
  .word-english { font-size: 22px; }
  #word-english-back { font-size: 18px; }
  #word-japanese { font-size: 14px; }
  .play-word-btn { width: 28px; height: 28px; font-size: 14px; }
  .card-controls button { width: 120px; padding: 8px 0; font-size: 16px; border-radius: 24px; }
  .progress-wrapper { height: 16px; }
  .progress-bar { font-size: 12px; }
}
</style>

<script>
document.addEventListener("turbo:load", () => {
  const vocabularies = window.VOCABULARIES;
  if (!vocabularies || vocabularies.length === 0) return;

  const card = document.getElementById("flash-card");
  const englishEl = document.getElementById("word-english");
  const englishBackEl = document.getElementById("word-english-back");
  const japaneseEl = document.getElementById("word-japanese");
  const prevBtn = document.getElementById("prev-card");
  const nextBtn = document.getElementById("next-card");
  const playBtn = document.getElementById("play-word");
  const playBtnBack = document.getElementById("play-word-back");
  const progressBar = document.getElementById("progress-bar");

  let current = 0;
  let voices = [];

  function loadVoices() {
    voices = speechSynthesis.getVoices();
  }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function speak(word) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = "en-US";
    utterance.rate = 0.95;
    utterance.pitch = 1.0;

    const voice = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'))
                  || voices.find(v => v.lang.startsWith('en'))
                  || voices[0];

    if (voice) utterance.voice = voice;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }

  function updateProgress(index) {
    const total = vocabularies.length;
    const percent = Math.round(((index + 1) / total) * 100);
    progressBar.style.width = percent + "%";
    progressBar.textContent = percent + "%";
  }

  function renderCard(index) {
    if (index >= vocabularies.length) {
      window.location.href = "<%= clear_vocabularies_path(level: params[:level]) %>";
      return;
    }

    const word = vocabularies[index];
    englishEl.textContent = word.english;
    englishBackEl.textContent = word.english;
    japaneseEl.textContent = word.japanese;
    card.classList.remove("is-flipped");

    speak(word.english);
    updateProgress(index);
  }

  renderCard(current);

  card.addEventListener("click", () => card.classList.toggle("is-flipped"));

  prevBtn.addEventListener("click", () => {
    if (current > 0) renderCard(--current);
  });

  nextBtn.addEventListener("click", () => {
    current++;
    renderCard(current);
  });

  playBtn.addEventListener("click", () => speak(englishEl.textContent));
  playBtnBack.addEventListener("click", () => speak(englishBackEl.textContent));
});
</script>
